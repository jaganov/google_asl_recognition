# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è RTX 4070 (12GB VRAM)

## üéØ –û–±–∑–æ—Ä –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

–î–∞–Ω–Ω—ã–π `train.py` –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è RTX 4070 —Å 12GB VRAM –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏.

## üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. ‚úÖ Batch Size Optimization
```python
batch_size = 12  # –û–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è RTX 4070 12GB VRAM
```
- **–ü—Ä–∏—á–∏–Ω–∞**: RTX 4070 –∏–º–µ–µ—Ç 12GB VRAM, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å batch_size=12
- **–≠—Ñ—Ñ–µ–∫—Ç**: –°—Ç–∞–±–∏–ª—å–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –±–µ–∑ OOM –æ—à–∏–±–æ–∫
- **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞**: –ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 16-20 –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è

### 2. ‚úÖ Mixed Precision Training (AMP)
```python
use_mixed_precision = True
from torch.cuda.amp import autocast, GradScaler
```
- **–ü—Ä–∏—á–∏–Ω–∞**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ FP16 –≤–º–µ—Å—Ç–æ FP32 —ç–∫–æ–Ω–æ–º–∏—Ç ~50% –ø–∞–º—è—Ç–∏
- **–≠—Ñ—Ñ–µ–∫—Ç**: 
  - –£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ–±—É—á–µ–Ω–∏—è –Ω–∞ 30-50%
  - –°–Ω–∏–∂–µ–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –Ω–∞ 50%
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ –æ–±—É—á–µ–Ω–∏—è
- **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É FP16/FP32

### 3. ‚úÖ Gradient Clipping
```python
gradient_clip_val = 1.0
torch.nn.utils.clip_grad_norm_(self.model.parameters(), self.gradient_clip_val)
```
- **–ü—Ä–∏—á–∏–Ω–∞**: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –≤–∑—Ä—ã–≤ –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤
- **–≠—Ñ—Ñ–µ–∫—Ç**: –°—Ç–∞–±–∏–ª—å–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ, –æ—Å–æ–±–µ–Ω–Ω–æ —Å –±–æ–ª—å—à–∏–º–∏ –º–æ–¥–µ–ª—è–º–∏
- **–ó–Ω–∞—á–µ–Ω–∏–µ**: 1.0 - –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤

### 4. ‚úÖ Gradient Accumulation
```python
gradient_accumulation_steps = 4  # –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π batch size = 48
```
- **–ü—Ä–∏—á–∏–Ω–∞**: –≠–º—É–ª–∏—Ä—É–µ—Ç –±–æ–ª—å—à–∏–π batch size –±–µ–∑ —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏
- **–≠—Ñ—Ñ–µ–∫—Ç**: 
  - –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π batch size = 12 * 4 = 48
  - –õ—É—á—à–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è
  - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª—å—à–∏–µ learning rates

### 5. ‚úÖ Memory Efficient DataLoader
```python
num_workers = 4,  # –û–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è RTX 4070
pin_memory = True  # –£—Å–∫–æ—Ä—è–µ—Ç –ø–µ—Ä–µ–¥–∞—á—É –¥–∞–Ω–Ω—ã—Ö –Ω–∞ GPU (–≤ get_dataloaders)
```
- **–ü—Ä–∏—á–∏–Ω–∞**: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
- **–≠—Ñ—Ñ–µ–∫—Ç**: 
  - –£—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
  - –°–Ω–∏–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è GPU
  - –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU

### 6. ‚úÖ CUDA Optimizations
```python
torch.backends.cudnn.benchmark = True
torch.backends.cudnn.deterministic = False
torch.cuda.empty_cache()  # –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏ –∫–∞–∂–¥—ã–µ 50 –±–∞—Ç—á–µ–π
```
- **–ü—Ä–∏—á–∏–Ω–∞**: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è CUDA –æ–ø–µ—Ä–∞—Ü–∏–π
- **–≠—Ñ—Ñ–µ–∫—Ç**: 
  - –£—Å–∫–æ—Ä–µ–Ω–∏–µ —Å–≤–µ—Ä—Ç–æ—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
  - –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é
  - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏

### 7. ‚úÖ PyTorch 2.0+ Compile (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```python
if hasattr(torch, 'compile'):
    self.model = torch.compile(self.model, mode='reduce-overhead')
```
- **–ü—Ä–∏—á–∏–Ω–∞**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏
- **–≠—Ñ—Ñ–µ–∫—Ç**: 
  - –£—Å–∫–æ—Ä–µ–Ω–∏–µ forward pass –Ω–∞ 20-30%
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
- **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è**: PyTorch 2.0+ + Triton (–º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ Windows)
- **Fallback**: –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –±–µ–∑ compile (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)

### 8. ‚úÖ Non-blocking Data Transfer
```python
features = batch['features'].to(self.device, non_blocking=True)
labels = batch['labels'].to(self.device, non_blocking=True)
```
- **–ü—Ä–∏—á–∏–Ω–∞**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö
- **–≠—Ñ—Ñ–µ–∫—Ç**: –ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –∏ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### GPU Memory Monitoring
```python
gpu_memory_used = torch.cuda.memory_allocated() / 1024**3
gpu_memory_cached = torch.cuda.memory_reserved() / 1024**3
print(f"GPU Memory: {gpu_memory_used:.1f}GB used, {gpu_memory_cached:.1f}GB cached")
```

### Memory Cleanup
```python
# –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏ –∫–∞–∂–¥—ã–µ 50 –±–∞—Ç—á–µ–π
if batch_idx % 50 == 0 and self.device.type == 'cuda':
    torch.cuda.empty_cache()
```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

```python
TRAINER_CONFIG = {
    'batch_size': 12,                    # –û–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è 12GB VRAM
    'gradient_accumulation_steps': 4,    # –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π batch size = 48
    'use_mixed_precision': True,         # AMP –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
    'gradient_clip_val': 1.0,           # –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è
    'num_workers': 4,                   # –û–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è RTX 4070
    'pin_memory': True,                 # –£—Å–∫–æ—Ä–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö
    'max_len': 384,                     # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    'dim': 192,                         # –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ (–º–æ–∂–Ω–æ 384)
}
```

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –î–ª—è –±–æ–ª—å—à–∏—Ö –º–æ–¥–µ–ª–µ–π (dim=384):
```python
trainer = ASLTrainer(
    batch_size=8,                       # –£–º–µ–Ω—å—à–∞–µ–º batch size
    dim=384,                           # –ë–æ–ª—å—à–∞—è –º–æ–¥–µ–ª—å
    gradient_accumulation_steps=6,     # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º accumulation
    use_mixed_precision=True,          # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞–µ–º AMP
)
```

### –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è:
```python
trainer = ASLTrainer(
    batch_size=16,                     # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º batch size
    gradient_accumulation_steps=3,     # –£–º–µ–Ω—å—à–∞–µ–º accumulation
    use_mixed_precision=True,          # AMP –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
)
```

### –î–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏:
```python
trainer = ASLTrainer(
    batch_size=8,                      # –£–º–µ–Ω—å—à–∞–µ–º batch size
    gradient_accumulation_steps=6,     # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º accumulation
    max_len=256,                       # –£–º–µ–Ω—å—à–∞–µ–º –¥–ª–∏–Ω—É –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    use_mixed_precision=True,          # AMP –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
)
```

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- **–°–∫–æ—Ä–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è**: 30-50% –±—ã—Å—Ç—Ä–µ–µ —Å AMP
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏**: 50% —ç–∫–æ–Ω–æ–º–∏–∏ —Å AMP
- **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å**: –£–ª—É—á—à–µ–Ω–∞ —Å gradient clipping
- **–ö–∞—á–µ—Å—Ç–≤–æ**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∏–ª–∏ —É–ª—É—á—à–µ–Ω–æ

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
- **GPU Memory**: ~8-10GB –∏–∑ 12GB –ø—Ä–∏ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
- **Training Speed**: ~2-3 –±–∞—Ç—á–∞/—Å–µ–∫ –Ω–∞ RTX 4070
- **Memory Efficiency**: 85-90% —É—Ç–∏–ª–∏–∑–∞—Ü–∏—è VRAM

## üöÄ –ó–∞–ø—É—Å–∫

### –¢–µ—Å—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:
```bash
cd src
python test_train_fix.py
```

### –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è:
```bash
cd src
python train.py
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ GPU:
```bash
# –í –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
watch -n 1 nvidia-smi
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **Mixed Precision**: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
2. **Gradient Clipping**: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
3. **Memory Cleanup**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–∞–∂–¥—ã–µ 50 –±–∞—Ç—á–µ–π
4. **PyTorch Version**: –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è PyTorch 2.0+ –¥–ª—è compile
5. **CUDA Version**: –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å CUDA 11.8+

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

–¢–µ–ø–µ—Ä—å `train.py` –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è RTX 4070:
- ‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ 12GB VRAM
- ‚úÖ –£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ–±—É—á–µ–Ω–∏—è –Ω–∞ 30-50%
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –±–µ–∑ OOM
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏
- ‚úÖ –ì–æ—Ç–æ–≤ –∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—é –≤—ã—Å–æ–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏

**–ì–æ—Ç–æ–≤–æ –∫ –±—ã—Å—Ç—Ä–æ–º—É –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–º—É –æ–±—É—á–µ–Ω–∏—é! üöÄ** 